# sdiffx - Static Diff Checking Tool

**PDFやExcelから抽出したテキストをLLMで整形したときに、意図しない変更がないか確認するツール**

完全vibe codingで作りました。
動作確認はほどほどにしかしてません。

---

## 使い方

### インストール

```bash
npm install
npm run build
```

### 基本的な使い方

**差分を確認するだけ**
```bash
node dist/index.js original.md formatted.md
```

**差分を確認して修正**
```bash
node dist/index.js -i original.md formatted.md
```

### インタラクティブモードの流れ

1. 差分を表示
2. 置換モードを選択：
   - `i`: 確認後置換（1件ずつ確認）
   - `b`: 全置換（全て一括適用）
3. ファイルが自動で修正される

---

## グローバルインストール（オプション）

コマンドラインで `sdiffx` コマンドを直接使えるようにします：

```bash
npm install -g .
# または
npm link
```

これで、どのディレクトリからでも以下が使えます：
```bash
sdiffx original.md formatted.md
sdiffx -i original.md formatted.md
```

登録解除: `npm uninstall -g sdiffx` または `npm unlink`

---

## このツールでできること

LLMがテキストを整形した時、以下のような問題を検知します：

- ✅ 予期しない文が追加されている
- ✅ 大切な文が削除されている
- ✅ Markdown 形式の変更（自動的に無視）

**比較方法**：
- Markdown シンタックス（`#`、`**` など）は無視
- 文単位で差分をチェック
- 空白・改行を基準に分割

---

## サンプルで試す

```bash
# サンプルテストを実行
./test-all-samples.sh
```

3つのサンプルシナリオが含まれています：

| サンプル | 説明 |
|---------|------|
| `sample_original.md` / `sample_formatted.md` | 整形による見出し追加 |
| `sample_missing_original.md` / `sample_missing_formatted.md` | 新しい文が追加 |
| `sample_extra_original.md` / `sample_extra_formatted.md` | 冗長な文が削除 |

---

## インタラクティブモード（詳細）

差分を確認してから修正したい場合は `sdiffx -i` を使用します。

### 確認後置換モード（推奨）

1つずつ確認しながら適用します：

```
確認後置換モード
1/3 完了 ・ 取り消し可能: 0

+ このテキストを追加しますか？
y: はい / n: スキップ / u: 1つ戻る / q: キャンセル
```

キー操作：
- `y`: この変更を適用
- `n`: スキップ
- `u`: 直前の変更を取り消し
- `q`: 終了

### 全置換モード

すべての差分を一括で適用します。確認プロセスをスキップします。

### 最終確認画面

すべての変更を選択後、ファイル保存前に一覧で確認できます：

```
置換内容の最終確認
モード: 確認後置換 ・ 選択済み: 2/3

置換リスト
- このテキストを削除
+ このテキストを追加
```

キー操作：
- `s`: 置換を保存（ファイルを更新）
- `u`: 直前の置換を取り消し
- `q`: 終了（保存しない）

---

## 出力形式

### Diff Summary（統計）

```
Total entries: 14
Added: 2
Removed: 0
Unchanged: 12
```

### Differences（差分一覧）

```
+ 追加された行
- 削除された行
  変わらない行
```

---

## 技術的な詳細

### テキスト処理の流れ

1. Markdown シンタックスを削除（`#`、`**`、`*` など）
2. 空白・改行を基準に文単位で分割
3. 空行はスキップ
4. 文の序列から差分を抽出

### マッチングアルゴリズム

複数の戦略で最適な対応行を検出：

1. **完全一致**: 元の行と整形後の行が完全に一致
2. **正規化一致**: 末尾の句点を除いて一致
3. **類似度マッチング**: 編集距離ベースで類似した行をマッチ

---

## 開発

### テスト実行

```bash
npm test                  # ユニットテスト
./test-all-samples.sh     # サンプルテスト
```

### ビルド

```bash
npm run build             # TypeScript → JavaScript
npm run lint              # ESLint実行
npm run dev               # 開発モード（ts-node）
```

---

## 制限事項

- 現在は文単位での比較（文字単位差分は未対応）
- 大規模ドキュメント（100MB+）は未最適化

---

## 注意点

- 整形前のファイルは Markdown シンタックスなしを想定
- 整形後のファイルは Markdown シンタックスありを想定
- この違いは比較時に自動的に無視される

---

## トラブルシューティング

### `sdiffx` コマンドが見つからない

```bash
# 再インストール
npm install -g .
```

### ファイル書き込み権限エラー

ファイルの書き込み権限を確認してください：

```bash
ls -la original.md formatted.md
```

### 差分が多すぎて確認が大変

確認後置換モードで `n` キーでスキップできます。最終確認画面で `u` キーで取り消しも可能です。
